# データ取得・格納実装計画書

## 1. 目的とスコープ
- 東証銘柄の株価データ（1分足・5分足・日足）を外部データソースから取得し、InfluxDB Cloud Serverless に蓄積する仕組みを構築する。
- デイトレ用ユニバース選定およびバックテストに必要なデータ品質と保持期間を MVP 水準で満たし、将来的な拡張（長期 1 分足・有償データ連携）が追加しやすい構造にする。
- 取得〜蓄積〜集計〜スコアリングまでの一連のパイプラインを `data_ingest` 配下に実装する。

## 2. データソースと制約
- **データ方針（MVP）**: yfinance を唯一のデータソースとして採用する。intraday は 1 分足 / 5 分足いずれも過去 60 日が上限だが、MVP では許容する。
- **拡張方針**: 1 年超の 1 分足が必要になった段階で JPX 有償データ（JPX Data Cloud / JPXI FLEX Historical / LSEG Tick History など）の導入を検討し、`raw_1m_backfill` バケットに流し込む。
- ティッカ形式: `<銘柄コード>.T`（例: 7203.T）。
- 取引時間: 09:00–11:30 / 12:30–15:00 (JST)。1 日当たり約 300 本の 1 分足。

## 3. データ保存方針（InfluxDB）
### 3.1 バケット設計
- `raw_1m_hot` : 1 分足ホットデータ保持 365 日。
- `raw_1m_backfill` : 有償データ等からの長期 1 分足（保持無制限を想定）。MVP では空のまま確保。
- `agg_5m` : 5 分足集計、保持 180–365 日。
- `agg_1d` : 日足集計、保持 5 年。

### 3.2 スキーマ
- measurement: `ohlcv_1m`
- tags: `symbol`, `exchange="TSE"`, `currency="JPY"`, `source` (例: `yf`, `jpx`)
- fields: `open`, `high`, `low`, `close` (double)、`volume` (long)
- timestamp: バー終値時刻（UTC、DST なし）

## 4. 実装フェーズとタスク
1. **InfluxDB セットアップ**
   - Org/Token 作成、保持期間設定、接続情報のシークレット管理。
   - バケットの存在と設定を記録する Runbook 整備。

2. **銘柄リスト同期（プリユニバース）**
   - 対象市場は **TSE Prime 限定**。銘柄コード CSV (`data/symbols_prime.csv`) を生成（初期投入＋週次更新）。
   - 上場・廃止・市場区分変更を週次で反映するスクリプト作成。

3. **バックフィル取得（MVP）**
   - yfinance で直近 60 日の 1 分足を取得し `raw_1m_hot` に書き込み。
   - 長期検証用に 1h / 日足を取得し `agg_1d` へ格納。
   - 営業日カレンダーを用いた取得ウィンドウ制御、UTC 変換、冪等書き込みを実装。

4. **日次・場中の定期取得**
   - 市場終了後に前営業日の 1 分足を確定取得（重複書き込みは上書きを許容）。
   - 5 分足相当のリアルタイム更新が必要な場合は `period="1d"` / `interval="1m"` を用いて 5 分ごとに再取得。
   - yfinance のレート制限に合わせたスロットリングと指数バックオフを実装。

5. **ダウンサンプリングと集計**
   - Influx SQL (`date_bin`, `selector_first`, `selector_last`) で 1 分→5 分/日足の OHLCV を生成。
   - バッチスクリプト (`pipeline/downsample_sql.py`) で定期実行し、結果を対応バケットへ書き戻す。

6. **品質チェックと監視**
   - ゼロ出来高率、ギャップ欠損、取得遅延を指標化し `monitor/checks.py` で可視化。
   - アラート閾値: 5 分足ゼロ出来高率 < 2%、場中遅延 < 90 秒、連続欠損が発生した場合は再取得。

7. **ユニバース選定スコアリング**
   - ハードフィルタを適用後、スコアリング指標を計算し Core 20 / Bench 5 を日次で更新。
   - セクター上限やヒステリシスなどの運用ルールを実装。

## 5. スコアリングとフィルタリング要件
### 5.1 ハードフィルタ（全て必須）
- **平均売買代金 (ADV)**: `mean(close * volume, 20d) ≥ 10〜20 億円`（最終値は口座規模で設定ファイル化）。
- **価格帯**: 500 円 ≤ 終値 ≤ 50,000 円。
- **ボラティリティ (ATR%)**: `ATR(14) / close` が 1.5%〜6% の範囲。
- **ゼロ出来高率**: 直近 60 営業日で連続ゼロ出来高の 5 分足バー比率 ≤ 2%。
- **空売り可否**: ショートを行う場合に売禁銘柄を除外（ロング専用リストに分離）。

### 5.2 スコアリング指標（重み合計 = 1.0）
- **流動性スコア (0.35)**: 20 日 ADV 順位を正規化し高流動銘柄を高得点。
- **ボラ適合スコア (0.25)**: `score_vol = 1 - clip(|ATR\% - 0.03| / 0.02, 0, 1)`。
- **実質コストスコア (0.20)**: `median_5m_range_bps = median((High-Low)/Close * 1e4)` の逆数ランク。
- **引け流動性スコア (0.15)**: `close_5m_vol_share`（引け前 5 分の出来高比率）のランク。
- **ゼロ出来高ペナルティ (0.05)**: `1 / no_trade_5m_ratio` のランク。

### 5.3 運用ルール
- **セクター上限**: 各業種の採用比率を 30% 以下に制限。
- **ヒステリシス**: 既存採用銘柄は総合スコア上位 30 位以内なら維持、新規採用は 15 位以内で追加。
- **除外リスト**: 「張り付き体質」など赤信号銘柄は別リストで強制除外。

### 5.4 オプション指標（将来拡張）
- **効率比 (ER)**: `|Close_last - Close_first| / Σ|ΔClose|`。60 日中央値が 0.35 以上を推奨。
- **ORB フォロー率**: Opening Range 突破後のフォロー成功率 ≥ 55%。
- **VWAP 片側滞在率**: セッション中 VWAP より上側滞在率 ≥ 55%。
- MVP では監視指標または総合スコアへの 0.2 程度の追加重みとして扱う。

## 6. 運用 SLA（初期案）
- **日次確定取得**: 市場終了後 30 分以内に前営業日の 1 分足取得と品質チェックを完了。
- **場中更新**: 任意実装時、5 分毎の取得遅延は 90 秒未満。3 回連続失敗でアラート発火。
- **ダウンサンプリング**: 1 日 1 回（マーケットクローズ後）＋週次再集計。
- **ユニバース確定**: 前営業日 23:00 JST までに Core 20 / Bench 5 を確定し通知。
- **監視**: 欠損率 > 閾値、遅延 > SLA、または API レート制限発生時に Pager / Slack 通知。

## 7. 成果物とディレクトリ構成
```
data_ingest/
  config/
    influx.toml           # 接続設定の参照用（秘匿情報は外部管理）
    trading_hours.json    # 東証カレンダー・祝日情報
  data/
    symbols_prime.csv     # 銘柄リスト（生成物）
  ingest/
    backfill_yf.py
    backfill_jpx.py
    daily_ingest.py
    intraday_ingest.py
  pipeline/
    downsample_sql.py
    metrics.py
    score_universe.py
  monitor/
    checks.py
  docs/
    RUNBOOK.md
    implementation_plan.md
```

## 8. 検証と受け入れ基準
- 任意 3 銘柄（例: 7203.T / 9984.T / 8035.T）で取得件数が理論値と一致すること。
- `agg_5m` のデータが 1 分足からの集計結果と一致すること。
- 品質メトリクス（ゼロ出来高率・ギャップ検知）が閾値内であること。
- Core 20 / Bench 5 のユニバースが日次で生成され、セクター上限・ヒステリシスが守られていること。

## 9. 今後の検討事項
- JPX 有償データ導入時の ETL モジュール設計と検証体制。
- オプション指標の重み付けや、スコアの自動チューニング（ベンチマーク比較）導入可否。
- yfinance API 制限変動時のフェイルオーバー戦略（キャッシュ／別 API）。

## 10. 次ステップ
- スコアリング定義を `pipeline/metrics.py` / `pipeline/score_universe.py` に反映するためのテストケースを設計。
- `config/` 配下に ADV 閾値・セクター上限・ヒステリシス設定を外部化する仕組みを実装。
- InfluxDB バケット・Retention 設定を確定し Runbook に手順を追記。
